---
layout:     post
title:      iOS中深度学习部署方案实现
subtitle:   pytorch模型文件.pth转换为.mlmodel
date:       2020-4-21
author:     JohnWayne
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - iOS
    - 深度学习
---

>深度学习部署到移动端除了苹果的MLCore，还有NCNN，MNN，这篇文章尝试用工具转换.pth模型到iOS适用的.mlmodel。

# 欢迎使用 Cmd Markdown 编辑阅读器

------

笔者希望将研究生阶段做的CGAN一直到ios端，由于是image segment，资料不是特别多，遇到许多坑，这里分享出来帮助大家排坑，共同学习。

------

## pytorch to CoreML

这里不做太多介绍，直接看流程图
![process](https://jianchao-li.github.io/post/from-pytorch-to-coreml/conversion.png)

### 1. 保存pytroch模型.pth文件

```python
#在train.py的最后加上

model = UnetGenerator(3,3,8)#input_nc=3,output_nc=3,num_downs=8(数字越大层级越复杂，模型也越臃肿)

torch.save(model.state_dict(),'Unet.pth')
```

### 2. pth2onnx

```python
from models.networks import *
model = UnetGenerator(3,3,8)
model.load_state_dict(torch.load("Unet.pth")) # pytorch模型加载
print(model)
batch_size =1  #批处理大小
input_shape = (3,256,256)   #输入数据

x = torch.randn(batch_size,*input_shape)		# 生成张量
torch.onnx.export(model, x, "Unet.onnx", verbose=True,input_names=['inputImage'],output_names=['outputImage'])#输入输出名要和后面保持一致
```


### 3. onnx2mlmodel
坑来了：一开始发现onnx的input尺寸是对的，但是转换成mlmodel后并不是Image，而是，直到在这个issue里找到了问题的所在。
https://github.com/onnx/onnx-coreml/issues/92
顺利解决

```python


```

### 4. 找一个写好的Xcode程序换模型
我希望是通过上传图片再转换的形式，下面这个项目挺合适
https://github.com/kirualex/NSTDemo

### 5. 修改参数
注意这里的尺寸

------

作者 [张巍] 
2020 年 04月 28日    


